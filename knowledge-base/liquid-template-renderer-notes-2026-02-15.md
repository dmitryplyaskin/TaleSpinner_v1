# Liquid Template Notes (2026-02-15)

Краткая фиксация договоренностей по LiquidJS-рендеру и ближайших улучшений.

## Что внедрено

- Добавлены алиасы в Liquid-контекст:
  - `{{lastUserMessage}}`
  - `{{lastAssistantMessage}}`
- Алиасы вычисляются из `messages` прямо в общем рендерере `renderLiquidTemplate(...)`,
  поэтому доступны во всех флоу, которые используют этот рендерер.

## Семантика алиасов

- `lastUserMessage`:
  - последнее сообщение с `role="user"` из `messages`.
- `lastAssistantMessage`:
  - последнее сообщение с `role="assistant"` из `messages`.
  - В `before_main_llm`: это прошлый ответ ассистента (до текущего user-turn).
  - В `after_main_llm`: это свежесгенерированный ответ основного LLM (если он добавлен в хвост `messages` перед рендером).

Если соответствующих сообщений нет, алиас возвращает пустую строку.

## Обновление UI-документации

- Liquid docs modal (RU/EN) обновлен:
  - добавлены `{{lastUserMessage}}` и `{{lastAssistantMessage}}` в список доступных переменных;
  - добавлены описания поведения для `before/after main llm`.

## Отложенные улучшения (не блокер)

1. Кешировать strict-engine (`strictVariables=true`) вместо создания `new Liquid(...)` на каждый вызов.
2. Проверять `maxOutputChars` сразу после первого прохода рендера (сейчас лимит влияет в первую очередь на дополнительные проходы).
3. Добавить debug-хук/лог для причин остановки multi-pass (ошибка парсинга на следующем проходе и т.п.).
4. В `buildInstructionRenderContext(...)` распараллелить независимые запросы (история/профиль) через `Promise.all`.
5. Проверить необходимость и фактическое использование `excludeMessageIds` в контекст-сборке/драфт-билдере.

