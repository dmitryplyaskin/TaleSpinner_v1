# v2 — Operation / kind=template (text + optional Liquid)

Этот документ описывает **контракт** для операций с `OperationDefinition.kind="template"`.

Идея: это **максимально простая операция**, у которой в конфиге есть **одно** большое текстовое поле.  
Этот текст **может** содержать LiquidJS-синтаксис (подстановки/фильтры), но **не обязан** — если Liquid не используется, результат будет тем же текстом.

## 0) Что это (простыми словами)

`kind="template"` — это операция “взяли строку из конфигурации → (опционально) отрендерили как Liquid по контексту Run → получили строку”.

Типичные кейсы:

- хранить “кусок промпта”, который включается гардом и вставляется в инструкции (через эффекты prompt-time или через артефакт);
- рендерить текст/HTML-фрагмент для UI на основе `art.*` (например `art.stats`).

## 1) Инварианты

- Операция **не вызывает LLM**.
- В конфигурации операции есть **ровно одно** пользовательское текстовое поле.
- Результат операции — **строка**.
- Операция может воздействовать на внешний мир только через `OperationResult.effects` (см. `10-operation.md`).
- Если операция завершилась не `done`, считаем что эффекты **не применились** (общие правила commit в `10-operation.md`).

## 2) `params` для `kind="template"` (минимум)

`OperationConfig.params` для `kind="template"` — JSON-объект:

- `template: string` — текст/шаблон (одно поле в UI)
- `strictVariables?: boolean` — если `true`, обращение к отсутствующим переменным → `status="error"` (`error.code="template_render_error"`)

Контекст шаблона (минимум):

- `art.<tag>` — артефакты (persisted и/или run_only)
- `chatHistory` — история чата (форма/фильтры описываются отдельной спекой LiquidJS-окружения)

## 3) Выполнение (execute)

1) Сформировать render context из `OperationContext` (см. `10-operation.md`).
2) Пропустить `params.template` через LiquidJS renderer и получить `rendered: string`.
   - если в тексте нет Liquid-конструкций, `rendered` будет равен исходному тексту (по смыслу).
3) Вернуть `OperationResult.status="done"` и эффекты, определённые конкретной операцией:
   - prompt-time эффекты (например вставка/обновление инструкций), и/или
   - запись **в один** `art.<tag>` (если операция пишет артефакт — действует правило v2 “1 операция → 1 tag”).

> Примечание: конкретно *куда* попадает `rendered` (в prompt-time, в UI, в артефакт) — это часть поведения конкретной операции (`operationId`) и её эффектов; `kind="template"` фиксирует только то, что источником является один текст/шаблон и результат — строка.

## 4) Ошибки (минимум)

- ошибка рендера Liquid (синтаксис/strictVariables) → `status="error"`, `error.code="template_render_error"`

