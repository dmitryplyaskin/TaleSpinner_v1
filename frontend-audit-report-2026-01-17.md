## Отчёт по фронтенду (аудит качества/архитектуры)

**Проект**: TaleSpinner_v1  
**Дата**: 2026‑01‑17  
**Контекст**: код фронта писался ~год назад; сейчас проект «реанимирован» и зависимости обновлены до актуальных.

### Объём и метод

- **Скоуп**: папка `web/` (Vite + React), ключевые зоны `web/src/features`, `web/src/model`, `web/src/ui`, `shared/types`.
- **Что сделано**:
  - статический обзор структуры и ключевых модулей (точки входа, модели, чат, сайдбары, markdown, стриминг);
  - попытка прогнать качество через инструменты репозитория:
    - `yarn lint` (в `web/`) — падает из‑за конфига ESLint/tseslint;
    - `yarn build` (в `web/`) — падает из‑за TS-ошибок (как из‑за обновлённых типов библиотек, так и из‑за реальных дефектов/недописанных файлов).

> Важно: ниже я намеренно разделяю **архитектурный потенциал** (как задумано) и **текущее техсостояние после апдейта** (как реально работает сейчас).

---

## 1) Краткий вывод

- **Архитектурный фундамент**: выше среднего. Есть слоистость и доменная модель (`src/model` на Effector, UI-слой `src/features`), выделенная UI-библиотека на Chakra (`src/ui`), переиспользуемые типы (`shared/types`).
- **Текущее техсостояние после обновления**: критичное. Фронт **не собирается** и **не линтится**, есть «обломки» компонентов и несовместимости типов после апдейта.
- **Главный риск**: без стабилизации сборки/линта и нормализации границ (инициализация, API-слой, побочные эффекты) поддержка будет быстро дорожать, а изменения — ломать соседние части.

---

## 2) Технологический стек (как сейчас)

- **Сборка**: Vite (`web/vite.config.ts`), TS project references (`web/tsconfig*.json`).
- **UI**: Chakra UI v3 (`@chakra-ui/react`), обёртки и компоненты в `web/src/ui/chakra-core-ui/*`.
- **Стейт**: Effector + patronum (`effector`, `effector-react`, `patronum`).
- **Формы**: `react-hook-form` (обвязки в `web/src/ui/form-components/*`).
- **Markdown**: `react-markdown` + `remark-gfm` + `rehype-raw` + кастомный плагин кавычек.
- **Сетевое взаимодействие**: преимущественно `fetch`, местами заявлен `axios` (по факту в прочитанных местах почти не используется).

---

## 3) Архитектура и структура (как устроено)

### 3.1. Слои и ответственность

- **UI/фичи**: `web/src/features/*`
  - чат: `features/chat-window/*`
  - сайдбары: `features/sidebars/*`
  - (есть ещё `features/api.tsx`, который выглядит как альтернативный/старый API-слой)
- **Домен/состояние**: `web/src/model/*`
  - `model/_fabric_/*` — фабрика CRUD-моделей (items/settings/sort-filter/pagination)
  - домены: `agent-cards`, `user-persons`, `templates`, `instructions`, `samplers`, `sidebars`, `chat-service`, `llm-orchestration`, …
- **UI kit / инфраструктурные компоненты**: `web/src/ui/*`
- **Типы**: `shared/types/*` (общие контракты между фронтом и бэком)

### 3.2. Плюсы текущей структуры

- **Доменная декомпозиция**: отдельные домены на Effector (понятные точки расширения).
- **Фабрика моделей**: повторное использование CRUD/настроек/сортировок/пагинации — хороший “скелет” для масштабирования.
- **Алиасы путей**: `@model`, `@ui`, `@utils`, `@shared` — повышают читаемость и уменьшают относительные импорты.

---

## 4) Фактическое состояние качества (инструментально)

### 4.1. ESLint не запускается (блокер)

Команда `yarn lint` в `web/` падает ошибкой совместимости конфига:

```text
ESLint: 9.39.2
Error: tseslint.config(): ... 'extends' array contains a string ("plugin:import/recommended") ...
This is a feature of eslint's defineConfig() helper and is not supported by typescript-eslint.
```

**Что это значит**: сейчас у тебя нет рабочего «quality gate» (даже локально), а форматирование/правила импортов и т.п. не могут стабильно применяться.

### 4.2. TypeScript сборка падает (блокер)

`yarn build` (tsc -b && vite build) падает большим списком ошибок. Самые характерные группы:

- **реальные поломки/недописанные файлы**: `web/src/features/chat-window/message/answer-block.tsx` — использует несуществующие символы.
- **ошибки типов после обновлений**: markdown/unist (`quote-plugin.tsx`, `render-md/*`), обработчики событий в Chakra/React 19, `unknown` в catch.
- **коллизии экспортов**: `web/src/model/index.ts` ре-экспортирует конфликтующие имена (`saveSettingsFx`).
- **возможные несовместимости Effector типов**: `web/src/model/chat-service/index.ts` — `sample({ source: ... })` не совпадает с ожидаемой сигнатурой.

---

## 5) Основные проблемы (качество/архитектура)

Ниже — список по приоритетам. “P0” — то, что блокирует разработку уже сейчас.

### P0 — блокеры (нужно чинить в первую очередь)

- **Сборка не проходит** (`web yarn build`).
  - **Симптом**: десятки TS-ошибок.
  - **Риск**: любые изменения трудно делать безопасно; CI (если есть) будет красным.
- **ESLint не работает** (`web yarn lint`).
  - **Симптом**: несовместимость `eslint.config.js` и `typescript-eslint`.
  - **Риск**: неконсистентный стиль/импорты; ошибки качества не ловятся автоматически.
- **Явно сломанный компонент**: `web/src/features/chat-window/message/answer-block.tsx` выглядит как незавершённый фрагмент (нет импортов, нет пропсов/данных).
- **Коллизии экспортов**: `web/src/model/index.ts` (ре-экспорт звёздочками) уже породил конфликт имён.

### P1 — высокая важность (стабильность, предсказуемость)

- **Побочные эффекты “на импорт”** в моделях:
  - `web/src/model/llm-settings.ts` вызывает `fetchSettingsFx()` в конце файла;
  - `web/src/model/sidebars.ts` вызывает `getSettingsFx()` в конце файла.
  - **Почему это плохо**: неявная инициализация усложняет тестирование, порядок загрузки модулей, повторное использование и дебаг.
- **Env-переменные для Vite**:
  - `web/src/const.ts` читает `import.meta.env.BACKEND_URL`, но в Vite обычно доступно только `VITE_*`.
  - **Риск**: неочевидные проблемы с окружениями (всегда “падает” на localhost).
- **Дублирование API-слоя**:
  - `web/src/api/openRouter.ts` и параллельно `web/src/features/api.tsx` + `fetch` внутри моделей.
  - **Риск**: расхождение типов/ошибок/ретраев; разный формат ответов; сложнее менять бэкенд.

### P2 — средняя важность (качество модели, DX, масштабирование)

- **Граница “домен ↔ UI” протекает**:
  - пример: `window.confirm` внутри `model/_fabric_/items-model.ts` (UI решение внутри домена).
- **Потоки/abort**:
  - `web/src/hooks/useStreamController.ts` создаёт streamId не стабильно (создание вне `useMemo/useRef`).
  - `model/llm-orchestration` использует собственный `StreamController`, но местами создаёт новые streamId без явного lifecycle-контроля.
- **Рендер чата**:
  - `RenderChat` использует `key={index}` — при изменениях массива сообщений возможны неправильные реюзы.
- **Сохранение настроек сайдбаров**:
  - сохранение триггерится на каждое изменение `changeSidebarSettings` без дебаунса — потенциально “ддос” бэкенда при активном UI.
- **Логирование и ошибки**:
  - `async-handler.ts`: `isLog: ... || true` фактически всегда включает логирование;
  - много `catch (error)` без narrowing → после обновления TS это ломает типизацию (`unknown`).

### P3 — “хорошо бы” (долгосрочно)

- **Тесты**: в текущей структуре практически просится хотя бы минимальный слой тестов на фабрику моделей/рендер шаблонов/стриминг.
- **Типизация API-ответов**: у `fetch(...).json()` почти нигде нет валидирующего/типизирующего слоя (zod/io-ts хотя бы для критичных ответов).
- **i18n/тексты**: смешение RU/EN строк и терминов; дальше будет болеть, если добавится локализация.

---

## 6) Точки, где “апдейт зависимостей” особенно ударил

Это места, которые типично ломаются при переходе на новые версии TS/React/Chakra/unist:

- **ESLint flat-config + typescript-eslint**: формат конфигурации и совместимость “extends” изменились.
- **React 19 типы**: `catch` → `unknown`, обработчики событий, `EventTarget` без `value`.
- **remark/unist типы**: сигнатуры `visit` и visitor’ов стали строже, возвращаемые значения и типы `Parent/index` часто требуют уточнения.
- **Effector типы**: `sample`/`attach` и строгая типизация `source/clock/target` иногда начинает “светить” скрытые несоответствия.

---

## 7) Рекомендации (дорожная карта)

### Этап A (P0): снова сделать проект “зелёным”

Цель: **`yarn build` проходит**, **`yarn lint` работает**.

- Починить `eslint.config.js` под текущую связку ESLint 9 + tseslint + import plugin.
- Убрать/починить сломанные/недописанные компоненты (в первую очередь `answer-block.tsx`).
- Разрулить конфликты экспортов в `model/index.ts`:
  - либо именованные ре-экспорты,
  - либо `export *` только из “безопасных” модулей,
  - либо создание “public API” файлов на уровне доменов.
- Привести “catch error” к narrowing (`error instanceof Error` и т.п.), чтобы TypeScript перестал падать.

### Этап B (P1): стабилизировать инициализацию и конфиги

Цель: убрать “магические” сайд-эффекты и сделать окружения управляемыми.

- Перевести `BACKEND_URL` на `VITE_BACKEND_URL` (и описать в `vite-env.d.ts`).
- Убрать автозапуски эффектов на импорт:
  - сделать явный `app/init` (например, `web/src/app/init.ts`) и вызывать его из `main.tsx`/`App.tsx`.
- Вынести повторяющийся `fetch` в единый слой API-клиента (перехват ошибок, базовые заголовки, retry, таймауты).

### Этап C (P2): улучшить границы и DX

- Убрать UI-зависимости из домена (`window.confirm` → подтверждение в UI).
- Дебаунсить сохранение настроек сайдбаров.
- Стабилизировать потоковый lifecycle:
  - сделать `useStreamController` создающим id один раз на маунт;
  - унифицировать abort/cleanup.
- Исправить `key={index}` в чате на стабильный `message.id`.

### Этап D (P3): качество на будущее

- Добавить минимальные тесты:
  - `buildMessages`, `renderTemplate`, фабрика сортировок/фильтров, потоковый парсер SSE.
- Ввести лёгкую валидацию критичных API-ответов (хотя бы для настроек/моделей).
- Документировать “правила архитектуры” (где что живёт, как добавлять новый домен/сайдбар/CRUD-модель).

---

## 8) Конкретные “быстрые победы” (quick wins)

- Исправить `async-handler.ts`: сделать `isLog` реально зависящим от env (сейчас оно всегда true).
- Убрать дубли `BASE_URL` и привести к единому источнику (`web/src/const.ts`).
- Почистить `web/src/ui/chakra-core-ui/provider.tsx`: строка `"use client"` в Vite‑проекте выглядит лишней и может вводить в заблуждение.
- Свести `openRouter` API в одно место (выбрать `web/src/api/*` либо доменные эффекты, но не оба сразу).

---

## 9) Итоговая оценка

- **Структура и задумка**: хорошие, есть база для аккуратного масштабирования.
- **Главная проблема сейчас**: проект после обновления зависимостей находится в “полурасколотом” состоянии (lint+build красные), поэтому любое развитие будет сопровождаться лавиной регрессий.
- **Лучший следующий шаг**: короткий «стабилизационный спринт» (P0/P1), после которого уже можно уверенно добавлять фичи и рефакторить без страха.
